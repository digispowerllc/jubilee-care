generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_JCG__PRISMA_DATABASE_URL")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String // e.g., "ACCOUNT_DEACTIVATION", "LOGIN", "PASSWORD_CHANGE"
  details   String? // Additional details about the action
  ipAddress String
  userAgent String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  Json?

  // Relationship to Agent (matches your existing pattern)
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes matching your schema style
  @@index([agentId])
  @@index([action])
  @@index([createdAt])
}

model Agent {
  id                 String    @id @default(uuid())
  fieldId            String
  surname            String
  firstName          String
  otherName          String
  email              String
  phone              String
  nin                String    @unique
  state              String
  lga                String
  address            String
  emailHash          String    @unique
  phoneHash          String    @unique
  ninHash            String    @unique
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt
  lastLoginAt        DateTime?
  lastLoginAttemptIp String?
  isActive           Boolean   @default(true)
  status             String    @default("")
  admittedAt         DateTime?
  deletedAt          DateTime?
  deletionReason     String?
  deactivatedAt      DateTime?
  deactivationReason String?
  avatarUrl          String    @default("")

  profile            AgentProfile?
  sessions           AgentSession[]
  oauthAccounts      OAuthAccount[]
  PasswordResetToken PasswordResetToken[]
  PasswordResetEvent PasswordResetEvent[]
  AuditLog           AuditLog[]
  DeletionSchedule   DeletionSchedule[]

  @@index([emailHash])
  @@index([phoneHash])
  @@index([ninHash])
  @@index([state])
  @@index([lga])
  @@index([createdAt])
}

model AgentProfile {
  id                    String    @id @default(uuid())
  agentId               String    @unique
  email                 String
  emailHash             String    @unique
  phone                 String
  phoneHash             String    @unique
  pin                   String    @default("")
  pinHash               String    @default("")
  passwordHash          String
  emailVerified         DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt
  passwordResetAttempts Int?
  accountLockedUntil    DateTime?
  lockoutCount          Int       @default(0)
  lastPasswordResetAt   DateTime?
  avatarUrl             String    @default("")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  PasswordResetToken PasswordResetToken[]

  @@index([agentId])
  @@index([phoneHash])
  @@index([emailHash])
  @@index([pinHash])
  @@index([createdAt])
}

model AgentSession {
  id        String    @id @default(cuid())
  token     String    @unique
  agentId   String
  agent     Agent     @relation(fields: [agentId], references: [id])
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  @@index([agentId])
  @@index([expiresAt])
}

model DeletionSchedule {
  id           String    @id @default(cuid())
  agentId      String
  agent        Agent     @relation(fields: [agentId], references: [id])
  scheduledAt  DateTime
  deletionType String // "FULL_ACCOUNT" or "DATA_ONLY"
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  @@index([agentId])
  @@index([scheduledAt])
}

enum AgentStatus {
  ACTIVE
  DEACTIVATED
  PENDING_DELETION
  DELETED
}

model Lockout {
  id    String   @id // could be IP or account ID
  until DateTime
}

model PasswordResetToken {
  id             String        @id @default(cuid())
  tokenHash      String        @unique
  agentId        String
  agent          Agent         @relation(fields: [agentId], references: [id])
  createdAt      DateTime      @default(now())
  expiresAt      DateTime
  usedAt         DateTime?
  AgentProfile   AgentProfile? @relation(fields: [agentProfileId], references: [id])
  agentProfileId String?

  @@index([agentId])
  @@index([expiresAt])
}

model PasswordResetEvent {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  createdAt DateTime @default(now())
  ipAddress String
  userAgent String?

  @@index([agentId, createdAt])
}

model User {
  id                String    @id
  username          String    @unique
  passwordHash      String
  email             String    @unique
  verified          Int       @default(0)
  fullName          String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now())
  bio               String    @default("")
  country           String    @default("")
  state             String    @default("")
  city              String    @default("")
  address           String    @default("")
  phoneNumber       String    @unique
  phoneVerified     Boolean   @default(false)
  hasPin            Boolean   @default(false)
  pinHash           String?
  isBanned          Boolean   @default(false)
  passwordChangedAt DateTime?
  role              String    @default("user")
  sessions          Session[]
  roles             UserRole?

  @@index([username])
  @@index([email])
  @@index([phoneNumber])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([country])
  @@index([state])
  @@index([city])
  @@index([address])
  @@index([bio])
  @@index([phoneVerified])
  @@index([hasPin])
  @@index([isBanned])
  @@index([passwordChangedAt])
}

model UserRole {
  id   String @id
  role String @default("agent")
  user User   @relation(fields: [id], references: [id], onDelete: Cascade)
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  revoked   Boolean  @default(false)
  userAgent String?
  ipAddress String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model OAuthAccount {
  id         String   @id @default(cuid())
  provider   String
  providerId String
  agentId    String
  createdAt  DateTime @default(now())
  agent      Agent    @relation(fields: [agentId], references: [id])

  @@unique([provider, providerId])
}
